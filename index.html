<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Vietnam Lifestyle Itinerary</title>
  <style>
    :root{
      --bg:#ffffff;
      --surface:#fafafa;
      --card:#ffffff;
      --ink:#111111;
      --muted:#555555;
      --line:#e6e6e6;
      --chip:#f1f1f1;
      --press:#f3f3f3;
      --safeTint:#fbf7ef; /* soft beige */
      --radius:16px;
      --shadow:none;
      --pad:14px;
      --gap:12px;
      --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Inter",Segoe UI,Roboto,Arial,sans-serif;
    }
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important;}
    }
    html,body{height:100%; background:var(--bg); color:var(--ink); font-family:var(--font);}
    body{margin:0;}
    .app{min-height:100%; display:flex; flex-direction:column; padding-bottom:78px;}

    /* Header */
    .header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,0.92);
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 14px calc(10px + env(safe-area-inset-top));
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .title{
      font-size:20px; line-height:1.2; font-weight:650;
      letter-spacing:-0.01em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sub{
      margin-top:6px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pillRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--card);
      font-size:13px;
      color:var(--muted);
      user-select:none;
    }
    .pill select{
      appearance:none; -webkit-appearance:none;
      background:transparent;
      border:none;
      color:var(--ink);
      font-size:13px;
      outline:none;
      max-width:200px;
    }

    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--ink);
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
    }
    .btn:active{transform:scale(0.98); background:var(--press);}
    .btn.ghost{background:transparent;}
    .btn.primary{border-color:var(--ink);}

    /* Toggle */
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:var(--card);
      font-size:13px;
      color:var(--muted);
    }
    .switch{width:38px; height:22px; border-radius:999px; background:#ddd; position:relative; flex:0 0 auto;}
    .switch::after{content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:white; transition:transform 160ms ease;}
    .switch.on{background:#111;}
    .switch.on::after{transform:translateX(16px);}

    /* Content */
    .content{padding:14px; display:flex; flex-direction:column; gap:12px;}

    .sectionTitle{
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      margin:4px 2px 8px;
    }

    .toolkit{
      position:sticky;
      top:calc(74px + env(safe-area-inset-top));
      z-index:10;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--surface);
      overflow:hidden;
    }
    .toolkitHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
    }
    .toolkitHead strong{font-size:13px;}
    .toolkitBody{padding:0 14px 12px; color:var(--muted); font-size:13px; line-height:1.35;}
    .toolkitBody ul{margin:8px 0 0 18px; padding:0;}

    /* Card */
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--card);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card.safe{background:var(--safeTint);}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .meta{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .chip{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      font-size:12px;
      color:var(--ink);
    }
    .chip.muted{color:var(--muted);} 
    .chip.outline{background:transparent; border:1px solid var(--line);} 

    .h1{font-size:20px; font-weight:650; letter-spacing:-0.01em; margin:0;}
    .subline{font-size:13px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap;}
    .addr{
      font-size:13px;
      color:var(--ink);
      text-decoration:none;
      border-radius:10px;
      padding:8px 10px;
      background:var(--surface);
      border:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .addr:active{transform:scale(0.99); background:var(--press);}
    .addr small{color:var(--muted);}

    .btnRow{display:flex; gap:8px; flex-wrap:wrap;}

    details{
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    details summary{
      cursor:pointer;
      list-style:none;
      font-size:13px;
      color:var(--ink);
      font-weight:600;
    }
    details summary::-webkit-details-marker{display:none;}
    .noteArea{
      width:100%;
      min-height:64px;
      resize:vertical;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-family:var(--font);
      font-size:13px;
      outline:none;
      background:#fff;
      box-sizing:border-box;
    }

    .collapsed{
      opacity:0.92;
    }

    /* Accordion day */
    .day{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--surface);
      overflow:hidden;
    }
    .dayHead{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .dayHead:active{background:var(--press);}
    .dayTitle{font-size:14px; font-weight:700;}
    .dayMeta{font-size:12px; color:var(--muted);}
    .dayBody{padding:14px; display:none; gap:12px; flex-direction:column;}
    .day.open .dayBody{display:flex;}

    /* Bottom tabs */
    .tabs{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,0.92);
      backdrop-filter:saturate(160%) blur(10px);
      border-top:1px solid var(--line);
      display:flex;
      gap:8px;
      justify-content:space-between;
      z-index:30;
    }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:var(--ink);
      color:var(--ink);
    }
    .tab:active{transform:scale(0.98); background:var(--press);}

    /* Modal bottom sheet */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .sheet{
      width:100%;
      max-width:520px;
      background:var(--bg);
      border-radius:18px 18px 0 0;
      border:1px solid var(--line);
      padding:12px 14px 18px;
      box-sizing:border-box;
    }
    .sheetHandle{width:44px;height:5px;border-radius:999px;background:#ddd;margin:6px auto 10px;}
    .sheetTitle{font-weight:750; font-size:16px; margin:0 0 8px;}
    .sheetText{font-size:13px; color:var(--muted); line-height:1.35;}

    .twoCol{display:grid; grid-template-columns:1fr; gap:12px;}
    @media (min-width:520px){
      .twoCol{grid-template-columns:1fr 1fr;}
    }

    .danger{color:#b00020;}
    .small{font-size:12px; color:var(--muted);}

    input[type="text"], input[type="url"]{
      width:100%; box-sizing:border-box;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-family:var(--font);
      font-size:13px;
      outline:none;
      background:#fff;
    }
    label{font-size:12px; color:var(--muted); display:block; margin:2px 2px 6px;}

    .hr{height:1px; background:var(--line); margin:10px 0;}

    .linkList{display:flex; flex-direction:column; gap:8px;}
    .linkItem{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--card);
    }
    .linkItem a{color:var(--ink); text-decoration:none; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:64vw;}

    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:#fff;}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="titleRow">
        <div class="title" id="appTitle">Vietnam Lifestyle Map — Jan 26–30</div>
        <button class="btn" id="btnInstall" style="display:none;">Install</button>
      </div>
      <div class="sub">
        <div class="pillRow">
          <div class="pill">
            <span class="small">View</span>
            <select id="dateSelect" aria-label="Select date"></select>
          </div>
          <div class="toggle" id="ibsToggle" role="button" aria-label="Toggle IBS mode" tabindex="0">
            <span>IBS Mode</span>
            <div class="switch" id="ibsSwitch"></div>
          </div>
        </div>
        <div class="pillRow">
          <button class="btn" id="btnHotelMaps">Hotel Maps</button>
          <button class="btn" id="btnHotelGrab">Grab to Hotel</button>
        </div>
      </div>
    </div>

    <div class="content" id="viewRoot">
      <!-- Views render here -->
    </div>

    <div class="tabs" role="tablist" aria-label="Navigation">
      <div class="tab" data-tab="today" role="tab">Today</div>
      <div class="tab active" data-tab="byday" role="tab">By Day</div>
      <div class="tab" data-tab="map" role="tab">Map List</div>
      <div class="tab" data-tab="notes" role="tab">Notes</div>
      <div class="tab" data-tab="data" role="tab">Data</div>
    </div>
  </div>

  <!-- Bottom sheet modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheetHandle"></div>
      <h3 class="sheetTitle" id="sheetTitle">Prompts</h3>
      <div class="sheetText" id="sheetBody"></div>
      <div class="hr"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn" id="sheetClose">Close</button>
      </div>
    </div>
  </div>

<script>
/*****
 * Vietnam Itinerary Dashboard (Notion-like, black & white)
 * - Edit HOTEL_ADDRESS and ITINERARY_DEFAULT below
 * - All edits persist in localStorage
 *****/

const APP = {
  version: '1.1.0',
  storageKeys: {
    itinerary: 'vn_itinerary_json_v2',
    state: 'vn_itinerary_state_v2',
    backup: 'vn_itinerary_backup_v2'
  },
  timeOrder: ['Morning','Late Morning','Midday','Lunch','Afternoon','Golden Hour','Evening','Night'],
};

// 1) Hotel placeholder (edit anytime)
const HOTEL_ADDRESS = "PIN Truong Quyen Hotel, 33 Truong Quyen St, District 3, Ho Chi Minh City";

const TRIP_META = {
  title: 'Vietnam Lifestyle Map — Jan 26–30',
  base: 'PIN Truong Quyen Hotel (District 3)',
  city: 'Ho Chi Minh City, Vietnam'
};

function encodeQ(s){return encodeURIComponent((s||'').trim());}
function mapsUrlFromAddress(addr){
  const q = encodeQ(addr);
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}
function grabUrlFromAddress(addr){
  // Best-effort deep link (works as a web fallback)
  const dropoff = encodeQ(addr);
  return `https://www.grab.com/sg/transport/?pickup=My%20Location&dropoff=${dropoff}`;
}

// 2) Default itinerary data (editable)
const ITINERARY_DEFAULT = [
  {
    "id": "hotel",
    "day_label": "Arrival",
    "date": "2026-01-26",
    "time_block": "Evening",
    "start_time": "18:30",
    "end_time": "",
    "name": "PIN Truong Quyen Hotel (Check-in)",
    "type": "Hotel",
    "address": "33 Truong Quyen St (verify in booking)",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=PIN+Truong+Quyen+Hotel+District+3",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Check-in, shower, early sleep. Keep it simple after flight.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Hydrate.",
      "Do 2 minutes of breathing.",
      "Pack/plan 1 main goal for tomorrow."
    ],
    "priority": "Must",
    "duration_mins": 30,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-cokernut-cafe-q3",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Late Morning",
    "start_time": "10:15",
    "end_time": "",
    "name": "Cokernut Cafe (Q3)",
    "type": "Cafe",
    "address": "44 Truong Quyen, Ward 6",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=Cokernut+Cafe+44+Truong+Quyen+District+3",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Ease-in café near your base. Good first “coffee culture” read + journal.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-taipoz-art-supplies",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Late Morning",
    "start_time": "11:15",
    "end_time": "",
    "name": "Taipoz Art Supplies",
    "type": "Stationery",
    "address": "150/7/2 Nguyen Trai, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Taipoz+Art+Supplies+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Buy watercolor paper/postcards/pens. Quick stop—don’t over-shop.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Must",
    "duration_mins": 45,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-27-artbook-nguyen-dinh-chieu",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Late Morning",
    "start_time": "12:15",
    "end_time": "",
    "name": "Artbook (Nguyen Dinh Chieu)",
    "type": "Landmark",
    "address": "Nguyen Dinh Chieu, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Artbook+Nguyen+Dinh+Chieu+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Art/architecture/design books \u0026 zines. Sketch book covers/typography.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-saigon-central-post-office",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Midday",
    "start_time": "12:00",
    "end_time": "",
    "name": "Saigon Central Post Office",
    "type": "Landmark",
    "address": "2 Cong xa Paris, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Saigon+Central+Post+Office",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Creative anchor: arches + map details watercolor. Sit/rest (IBS-friendly).",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-banh-xeo-46a-ibs-modified-or-poke-saigon",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Lunch",
    "start_time": "13:00",
    "end_time": "",
    "name": "Banh Xeo 46A (IBS-modified) OR Poke Saigon",
    "type": "Restaurant",
    "address": "46A Dinh Cong Trang (Banh Xeo) / 42 Bis Ly Tu Trong (Poke)",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Banh+Xeo+46A+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Caution",
    "ibs_notes": "Choose based on gut: Poke = safest; Banh Xeo = try only if stable (ask light oil).",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Eat slow + small portions.",
      "Hydrate; 5-min walk after.",
      "Write 1 sentence: what felt safest today?"
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-27-galerie-quynh",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Afternoon",
    "start_time": "15:00",
    "end_time": "",
    "name": "Galerie Quynh",
    "type": "Landmark",
    "address": "118 Nguyen Van Thu, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Galerie+Quynh+118+Nguyen+Van+Thu",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Quiet contemporary art—visual rest + notes for branding research.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-xliii-coffee-beans-vibe",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Afternoon",
    "start_time": "16:00",
    "end_time": "",
    "name": "XLIII Coffee (beans + vibe)",
    "type": "Cafe",
    "address": "178A Pasteur, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=XLIII+Coffee+178A+Pasteur+District+1",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Specialty espresso/pourover. Buy beans as “Saigon reference” (ask barista for best filter roast).",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-27-pasteur-nguyen-du-photo-walk",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Golden Hour",
    "start_time": "17:00",
    "end_time": "",
    "name": "Pasteur / Nguyen Du photo walk",
    "type": "Walk",
    "address": "Pasteur \u0026 Nguyen Du area",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Pasteur+Street+District+1+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Short golden-hour street photography loop. Keep it under 45–60 mins.",
    "creative_mode": "Photo",
    "creative_prompts": [
      "Limit loop to 45–60 mins.",
      "Shoot 10 photos: shadows, signage, people flow.",
      "Choose 1 hero shot to keep."
    ],
    "priority": "Must",
    "duration_mins": 50,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-27-quan-bui-bistro",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Evening",
    "start_time": "18:30",
    "end_time": "",
    "name": "Quan Bui Bistro",
    "type": "Landmark",
    "address": "222-224 Le Thanh Ton, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Quan+Bui+Bistro+Le+Thanh+Ton",
    "grab_url": "",
    "ibs_level": "Avoid",
    "ibs_notes": "Early dinner. IBS: choose grilled protein + rice; avoid heavy sauces/garlic.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-28-l-usine-thao-dien",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "L’Usine Thao Dien",
    "type": "Landmark",
    "address": "24 Thao Dien, Thu Duc City",
    "district": "D2",
    "google_maps_url": "https://maps.google.com/?q=L%27Usine+Thao+Dien",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Slow design café + retail. Sketch plants/ceramics/shelving.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-amai-house-lifestyle-curation",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Late Morning",
    "start_time": "10:15",
    "end_time": "",
    "name": "amai house (lifestyle curation)",
    "type": "Concept store",
    "address": "14 Tran Ngoc Dien, Thao Dien",
    "district": "D2",
    "google_maps_url": "https://maps.google.com/?q=amai+house+14+Tran+Ngoc+Dien",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Gallery-like home/lifestyle. Great for Cucufate + Lota Kopi inspiration.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Must",
    "duration_mins": 50,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-ibs-safe-rice-protein-nearby-thao-dien",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Lunch",
    "start_time": "13:00",
    "end_time": "",
    "name": "IBS-safe rice + protein nearby (Thao Dien)",
    "type": "Landmark",
    "address": "Thao Dien",
    "district": "D2",
    "google_maps_url": "https://maps.google.com/?q=Thao+Dien+District+2+restaurants",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Ask: no garlic/onion, light oil. Keep portions small.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-vesta-lifestyle-gifts",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Afternoon",
    "start_time": "15:00",
    "end_time": "",
    "name": "Vesta Lifestyle \u0026 Gifts",
    "type": "Concept store",
    "address": "Thao Dien",
    "district": "D2",
    "google_maps_url": "https://maps.google.com/?q=Vesta+Lifestyle+Thao+Dien",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Home goods + gifts—packaging + material cues.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Must",
    "duration_mins": 50,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-28-muji-saigon-centre-muji-cafe-optional",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Afternoon",
    "start_time": "16:00",
    "end_time": "",
    "name": "MUJI Saigon Centre (MUJI Cafe optional)",
    "type": "Cafe",
    "address": "65 Le Loi, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=MUJI+Saigon+Centre+65+Le+Loi",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Study product forms + shelving rhythm. If hungry: MUJI cafe simple set.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-aluvia-chocolatier",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Afternoon",
    "start_time": "17:00",
    "end_time": "",
    "name": "Aluvia Chocolatier",
    "type": "Landmark",
    "address": "(verify on maps)",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Aluvia+Chocolatier+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Small dark chocolate tasting; sketch packaging + texture study.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-28-okkio-caffe-opera-house-vibe",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Afternoon",
    "start_time": "18:00",
    "end_time": "",
    "name": "Okkio Caffe (Opera House vibe)",
    "type": "Landmark",
    "address": "120-122 Le Loi, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Okkio+Caffe+120-122+Le+Loi+District+1",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Big-city coffee culture + people watching. Good for espresso reference.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-28-den-long-restaurant",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Evening",
    "start_time": "18:30",
    "end_time": "",
    "name": "Den Long Restaurant",
    "type": "Restaurant",
    "address": "(verify on maps)",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=D%C3%A8n+L%E1%BB%93ng+Restaurant+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Avoid",
    "ibs_notes": "Calm, home-style Vietnamese dinner. IBS: simple rice + protein + veg.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Eat slow + small portions.",
      "Hydrate; 5-min walk after.",
      "Write 1 sentence: what felt safest today?"
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-quan-an-ngon-light-order",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "Quan An Ngon (light order)",
    "type": "Landmark",
    "address": "160 Pasteur, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Qu%C3%A1n+%C4%82n+Ngon+160+Pasteur",
    "grab_url": "",
    "ibs_level": "Avoid",
    "ibs_notes": "IBS-safe pho/bun—ask no garlic/onion. Eat slowly.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-stationery-street-small-local-paper-shops",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Late Morning",
    "start_time": "10:15",
    "end_time": "",
    "name": "Stationery street / small local paper shops",
    "type": "Stationery",
    "address": "Tong Duy Tan area",
    "district": "D5",
    "google_maps_url": "https://maps.google.com/?q=T%E1%BB%95ng+Duy+T%C3%A2n+Stationery+Street+District+5",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Paper goods + packaging inspiration. Keep it short + focused list.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Must",
    "duration_mins": 45,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-lam-xua-nha-hang-mon-viet-ibs-modified",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Lunch",
    "start_time": "13:00",
    "end_time": "",
    "name": "Lam Xua – Nha Hang Mon Viet (IBS-modified)",
    "type": "Landmark",
    "address": "211B Dien Bien Phu, District 3",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=Lam+Xua+211B+Dien+Bien+Phu+District+3",
    "grab_url": "",
    "ibs_level": "Avoid",
    "ibs_notes": "Grilled fish/chicken + rice. Avoid rich broths, heavy herbs, sauces.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-hcmc-museum-of-fine-arts",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Afternoon",
    "start_time": "15:00",
    "end_time": "",
    "name": "HCMC Museum of Fine Arts",
    "type": "Gallery",
    "address": "97A Pho Duc Chinh, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=HCMC+Museum+of+Fine+Arts",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Courtyard + stair sketches. Colonial textures, color palette notes.",
    "creative_mode": "Photo",
    "creative_prompts": [
      "Pick 1 artwork that stays with you.",
      "Write 5 words on the space.",
      "Take 3 calm photos: texture, frame, light."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-29-the-workshop-coffee-beans-brew-bar",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Afternoon",
    "start_time": "16:00",
    "end_time": "",
    "name": "The Workshop Coffee (beans + brew bar)",
    "type": "Cafe",
    "address": "27 Ngo Duc Ke, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=The+Workshop+Coffee+27+Ng%C3%B4+%C4%90%E1%BB%A9c+K%E1%BA%BF+District+1",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Classic Saigon specialty café in an old building. Buy beans + try pourover.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-shin-coffee-buy-beans",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Afternoon",
    "start_time": "17:00",
    "end_time": "",
    "name": "Shin Coffee (buy beans)",
    "type": "Cafe",
    "address": "18 Ho Huan Nghiep, District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Shin+Coffee+18+H%E1%BB%93+Hu%E1%BA%A5n+Nghi%E1%BB%87p+District+1",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Local specialty roaster. Great for bean shopping + Vietnamese-origin options.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-photo-walk-around-museum-ben-thanh-edge",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Golden Hour",
    "start_time": "17:00",
    "end_time": "",
    "name": "Photo walk around museum / Ben Thanh edge",
    "type": "Gallery",
    "address": "Pho Duc Chinh / Ben Thanh area",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=97A+Pho+Duc+Chinh+District+1",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Architecture + street life. Stop whenever tired (IBS pacing).",
    "creative_mode": "Photo",
    "creative_prompts": [
      "Pick 1 artwork that stays with you.",
      "Write 5 words on the space.",
      "Take 3 calm photos: texture, frame, light."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-29-free-early-night",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Evening",
    "start_time": "18:30",
    "end_time": "",
    "name": "Free / early night",
    "type": "Landmark",
    "address": "Hotel base",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Recovery night. Light stretching/yoga + hydration.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-kocha-matcha-spot",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "Kocha Matcha Spot",
    "type": "Cafe",
    "address": "(verify on maps)",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=Kocha+Matcha+Spot+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Matcha + quiet reflection journaling. Low-acid option vs coffee.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-ben-thanh-market-light-browse",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Late Morning",
    "start_time": "10:15",
    "end_time": "",
    "name": "Ben Thanh Market (light browse)",
    "type": "Market",
    "address": "Ben Thanh Market",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Ben+Thanh+Market",
    "grab_url": "",
    "ibs_level": "Caution",
    "ibs_notes": "Street photo + very quick souvenir run. Don’t overheat/overwalk.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Note one detail you noticed.",
      "Take 3 reference photos.",
      "Write 1 line: what to copy/avoid."
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-30-poke-saigon-or-rice-field-safe-or-very-light-qua",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Lunch",
    "start_time": "13:00",
    "end_time": "",
    "name": "Poke Saigon OR Rice Field (safe) OR very light Quan An Ngon",
    "type": "Restaurant",
    "address": "Choose nearest branch",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Poke+Saigon+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Choose safest + familiar. Keep it simple—avoid new foods before flight.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Eat slow + small portions.",
      "Hydrate; 5-min walk after.",
      "Write 1 sentence: what felt safest today?"
    ],
    "priority": "Must",
    "duration_mins": 60,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-airport-transfer",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Evening",
    "start_time": "18:30",
    "end_time": "",
    "name": "Airport transfer",
    "type": "Walk",
    "address": "To SGN Airport",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=Tan+Son+Nhat+International+Airport",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Leave ~7:00 PM, arrive ~8:00 PM. Calm, unrushed.",
    "creative_mode": "Photo",
    "creative_prompts": [
      "Limit loop to 45–60 mins.",
      "Shoot 10 photos: shadows, signage, people flow.",
      "Choose 1 hero shot to keep."
    ],
    "priority": "Must",
    "duration_mins": 50,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-bosgaurus-coffee-roasters-opera-house-or-okkio-i",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "Bosgaurus Coffee Roasters (Opera House) OR Okkio (if missed)",
    "type": "Cafe",
    "address": "12 Nguyen Sieu (Bosgaurus) / 120-122 Le Loi (Okkio)",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Bosgaurus+Coffee+Roasters+12+Nguyen+Sieu+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Final bean pickup (ask for travel-friendly whole beans + roast date).",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Must",
    "duration_mins": 75,
    "tags": [],
    "skip_if_tired": true
  },
  {
    "id": "2026-01-30-return-to-hotel-shower-pack-rest",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "Return to hotel: shower + pack + rest",
    "type": "Hotel",
    "address": "Hotel base",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=PIN+Truong+Quyen+Hotel+District+3",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Long rest window to protect digestion before flying. Hydrate.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Hydrate.",
      "Do 2 minutes of breathing.",
      "Pack/plan 1 main goal for tomorrow."
    ],
    "priority": "Must",
    "duration_mins": 30,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-very-light-rice-egg-chicken-near-hotel",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Evening",
    "start_time": "",
    "end_time": "",
    "name": "Very light rice + egg/chicken (near hotel)",
    "type": "Hotel",
    "address": "Near District 3",
    "district": "D3",
    "google_maps_url": "https://maps.google.com/?q=District+3+Ho+Chi+Minh+City+rice+egg",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "No new foods. Small portion.",
    "creative_mode": "Rest",
    "creative_prompts": [
      "Hydrate.",
      "Do 2 minutes of breathing.",
      "Pack/plan 1 main goal for tomorrow."
    ],
    "priority": "Must",
    "duration_mins": 30,
    "tags": [],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-d3morning-1-every-half-coffee-roasters-tu-xuong",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "Every Half Coffee Roasters (Tu Xuong)",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=Every+Half+Coffee+Roasters+(Tu+Xuong)+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-27-d3morning-2-saigon-coffee-roastery",
    "day_label": "Day 1",
    "date": "2026-01-27",
    "time_block": "Morning",
    "start_time": "09:30",
    "end_time": "",
    "name": "Saigon Coffee Roastery",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=Saigon+Coffee+Roastery+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-d3morning-1-hummingbird-cafe-roastery",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "Hummingbird Cafe + Roastery",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=Hummingbird+Cafe+++Roastery+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-28-d3morning-2-j-s-cafe",
    "day_label": "Day 2",
    "date": "2026-01-28",
    "time_block": "Morning",
    "start_time": "09:30",
    "end_time": "",
    "name": "J's Cafe",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=J's+Cafe+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-29-d3morning-1-anh-coffee-roastery",
    "day_label": "Day 3",
    "date": "2026-01-29",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "Anh Coffee Roastery",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=Anh+Coffee+Roastery+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "2026-01-30-d3morning-1-about-life-coffee-brewers",
    "day_label": "Day 4",
    "date": "2026-01-30",
    "time_block": "Morning",
    "start_time": "08:30",
    "end_time": "",
    "name": "About Life Coffee Brewers",
    "type": "Cafe",
    "address": "",
    "district": "D3",
    "google_maps_url": "https://www.google.com/maps/search/?api=1\u0026query=About+Life+Coffee+Brewers+District+3+Ho+Chi+Minh+City",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "D3 morning café option (walkable from hotel). Good for breakfast/brunch if you want to stay near base.",
    "creative_mode": "Read",
    "creative_prompts": [
      "Read 1 short chapter.",
      "Journal: 3 lines on mood + light.",
      "Capture 3 details: menu, packaging, signage."
    ],
    "priority": "Nice",
    "duration_mins": 75,
    "tags": [
      "d3-morning-plan"
    ],
    "skip_if_tired": false
  },
  {
    "id": "any-111-concept-store-by-vina-design",
    "day_label": "Optional",
    "date": "ANY",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "111 Concept Store by Vina Design",
    "type": "Concept store",
    "address": "District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=111+Concept+Store+Vina+Design+Saigon",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Vietnamese design objects \u0026 packaging study.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Optional",
    "duration_mins": 50,
    "tags": [
      "optional-anyday"
    ],
    "skip_if_tired": true
  },
  {
    "id": "any-ginkgo-concept-store",
    "day_label": "Optional",
    "date": "ANY",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "Ginkgo Concept Store",
    "type": "Concept store",
    "address": "District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Ginkgo+Concept+Store+Saigon",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Local fashion + culture-led design objects.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Optional",
    "duration_mins": 50,
    "tags": [
      "optional-anyday"
    ],
    "skip_if_tired": true
  },
  {
    "id": "any-whee-space",
    "day_label": "Optional",
    "date": "ANY",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "Whee Space",
    "type": "Concept store",
    "address": "District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Whee+Space+Saigon",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Small creative gifts \u0026 objects—quick browse.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Optional",
    "duration_mins": 50,
    "tags": [
      "optional-anyday"
    ],
    "skip_if_tired": true
  },
  {
    "id": "any-ta-concept-art-gifts-souvenirs",
    "day_label": "Optional",
    "date": "ANY",
    "time_block": "Afternoon",
    "start_time": "",
    "end_time": "",
    "name": "Ta Concept – Art Gifts \u0026 Souvenirs",
    "type": "Concept store",
    "address": "District 1",
    "district": "D1",
    "google_maps_url": "https://maps.google.com/?q=Ta+Concept+Art+Gifts+Saigon",
    "grab_url": "",
    "ibs_level": "Safe",
    "ibs_notes": "Art-led souvenirs \u0026 small works. Great last-minute gifts.",
    "creative_mode": "Sketch",
    "creative_prompts": [
      "Photograph 3 packaging layouts.",
      "Sketch one shelf rhythm (rectangles only).",
      "Note 3 materials/colors you’d reuse for Lota Kopi."
    ],
    "priority": "Optional",
    "duration_mins": 50,
    "tags": [
      "optional-anyday"
    ],
    "skip_if_tired": true
  }
];

/******** State ********/
function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    return fallback;
  }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

let itinerary = loadJSON(APP.storageKeys.itinerary, null);
if(!Array.isArray(itinerary)) itinerary = structuredClone(ITINERARY_DEFAULT);

let state = loadJSON(APP.storageKeys.state, {
  done: {},
  skipped: {},
  stopNotes: {},
  dayNotes: {},
  dayInspo: {}, // {date: [{label,url}]}
  settings: {
    ibsMode: false,
    filterSafeOnly: false,
    hideSkipIfTired: false,
    selectedDate: null,
    activeTab: 'byday'
  }
});

// Ensure hotel urls are generated
function hydrateLinks(){
  for(const s of itinerary){
    if(!s.address) continue;
    if(!s.google_maps_url) s.google_maps_url = mapsUrlFromAddress(s.address);
    if(!s.grab_url) s.grab_url = grabUrlFromAddress(s.address);
  }
}
hydrateLinks();

function persistAll(){
  saveJSON(APP.storageKeys.itinerary, itinerary);
  saveJSON(APP.storageKeys.state, state);
}

/******** UI helpers ********/
const el = (sel, root=document) => root.querySelector(sel);
const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function h(tag, attrs={}, children=[]){
  const node = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k === 'class') node.className = v;
    else if(k === 'html') node.innerHTML = v;
    else if(k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2), v);
    else if(v !== null && v !== undefined) node.setAttribute(k, v);
  }
  for(const c of (Array.isArray(children) ? children : [children])){
    if(c === null || c === undefined) continue;
    if(typeof c === 'string') node.appendChild(document.createTextNode(c));
    else node.appendChild(c);
  }
  return node;
}

function formatDayLabel(dateStr){
  const d = new Date(dateStr+'T00:00:00');
  const opt = {weekday:'short', month:'short', day:'numeric'};
  return d.toLocaleDateString(undefined,opt);
}

function timeRange(s){
  const a = (s.start_time||'').trim();
  const b = (s.end_time||'').trim();
  if(a && b) return `${a}–${b}`;
  if(a) return a;
  return '';
}

function stopSortKey(s){
  const tIdx = APP.timeOrder.indexOf(s.time_block);
  const t = (tIdx<0?99:tIdx);
  const start = (s.start_time||'').padStart(5,'0');
  return `${t}-${start}-${s.name}`;
}

function getDates(){
  const isISO = (d)=>/^\d{4}-\d{2}-\d{2}$/.test(String(d||''));
  const dates = [...new Set(itinerary.map(s=>s.date).filter(isISO))].sort();
  return dates;
}

function selectedDate(){
  const dates = getDates();
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  const saved = state.settings.selectedDate;
  if(saved && dates.includes(saved)) return saved;
  // Default to first day of trip if today not in range
  if(dates.includes(todayStr)) return todayStr;
  return dates[0] || todayStr;
}

function setSelectedDate(d){
  state.settings.selectedDate = d;
  persistAll();
}

function openSheet(title, htmlBody){
  el('#sheetTitle').textContent = title;
  el('#sheetBody').innerHTML = htmlBody;
  const ov = el('#overlay');
  ov.classList.add('show');
  ov.setAttribute('aria-hidden','false');
}
function closeSheet(){
  const ov = el('#overlay');
  ov.classList.remove('show');
  ov.setAttribute('aria-hidden','true');
}

function copyText(text){
  if(!text) return;
  navigator.clipboard?.writeText(text).catch(()=>{});
}

/******** Rendering ********/
function renderHeader(){
  el('#appTitle').textContent = TRIP_META.title;

  // Date selector
  const sel = el('#dateSelect');
  const dates = getDates();
  sel.innerHTML = '';
  for(const d of dates){
    const opt = document.createElement('option');
    const dayLabel = formatDayLabel(d);
    // Find day_label for that date
    const dayLbl = (itinerary.find(s=>s.date===d)?.day_label) || '';
    opt.value = d;
    opt.textContent = `${dayLbl} • ${dayLabel}`;
    sel.appendChild(opt);
  }
  sel.value = selectedDate();
  sel.onchange = () => { setSelectedDate(sel.value); render(); };

  // IBS toggle
  const sw = el('#ibsSwitch');
  if(state.settings.ibsMode) sw.classList.add('on'); else sw.classList.remove('on');
  el('#ibsToggle').onclick = () => { state.settings.ibsMode = !state.settings.ibsMode; persistAll(); render(); };
  el('#ibsToggle').onkeydown = (e) => { if(e.key==='Enter' || e.key===' ') el('#ibsToggle').click(); };

  // Hotel buttons
  const hotel = itinerary.find(s=>s.id==='hotel') || { address: HOTEL_ADDRESS };
  const hm = hotel.google_maps_url || mapsUrlFromAddress(hotel.address || HOTEL_ADDRESS);
  const hg = hotel.grab_url || grabUrlFromAddress(hotel.address || HOTEL_ADDRESS);
  el('#btnHotelMaps').onclick = () => window.open(hm, '_blank');
  el('#btnHotelGrab').onclick = () => window.open(hg, '_blank');

  // Install prompt
  if(window.__deferredPrompt){
    el('#btnInstall').style.display = 'inline-flex';
  }else{
    el('#btnInstall').style.display = 'none';
  }
}

function renderToolkit(){
  if(!state.settings.ibsMode) return null;
  const wrap = h('div',{class:'toolkit'},[
    h('div',{class:'toolkitHead'},[
      h('strong',{},['IBS Toolkit']),
      h('button',{class:'btn', onClick:()=>{
        const body = el('#toolkitBody');
        const open = body.style.display !== 'none';
        body.style.display = open ? 'none' : 'block';
      }},['Toggle'])
    ]),
    h('div',{class:'toolkitBody', id:'toolkitBody'},[
      h('div',{class:'small'},['Quick reminders for low-risk days:']),
      h('ul',{},[
        h('li',{},['Water + electrolytes.']),
        h('li',{},['Avoid garlic/onion; sauces on the side.']),
        h('li',{},['Prefer rice + lean protein; go easy on fried.']),
        h('li',{},['Early dinner; rest window before flight.']),
        h('li',{},['If unsure, choose the simplest option.'])
      ]),
      h('div',{style:'margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;'},[
        h('div',{class:'toggle', role:'button', tabindex:'0', onClick:()=>{state.settings.filterSafeOnly=!state.settings.filterSafeOnly; persistAll(); render();}},[
          h('span',{},['Safe+'] ),
          h('div',{class:'switch'+(state.settings.filterSafeOnly?' on':'')})
        ]),
        h('div',{class:'toggle', role:'button', tabindex:'0', onClick:()=>{state.settings.hideSkipIfTired=!state.settings.hideSkipIfTired; persistAll(); render();}},[
          h('span',{},['Hide “Skip if tired”'] ),
          h('div',{class:'switch'+(state.settings.hideSkipIfTired?' on':'')})
        ])
      ])
    ])
  ]);
  return wrap;
}

function renderStopCard(stop, withinDate){
  const done = !!state.done[stop.id];
  const skipped = !!state.skipped[stop.id];

  const isSafe = stop.ibs_level === 'Safe';
  const card = h('div',{class:'card'+(state.settings.ibsMode && isSafe ? ' safe' : '') + (done||skipped ? ' collapsed' : '')},[]);

  // Top meta row
  const leftMeta = h('div',{class:'meta'},[
    h('span',{class:'chip'},[stop.time_block]),
    timeRange(stop) ? h('span',{class:'chip muted'},[timeRange(stop)]) : null,
    stop.priority ? h('span',{class:'chip outline'},[stop.priority]) : null,
  ]);

  // Reorder controls (only inside By Day view)
  const reorder = h('div',{class:'meta'},[
    h('button',{class:'btn', title:'Move up', onClick:()=>moveStop(stop.id, -1)},['↑']),
    h('button',{class:'btn', title:'Move down', onClick:()=>moveStop(stop.id, +1)},['↓'])
  ]);

  // Title
  const title = h('p',{class:'h1'},[stop.name]);

  const subline = h('div',{class:'subline'},[
    stop.district ? h('span',{class:'chip'},[stop.district]) : null,
    stop.type ? h('span',{class:'chip muted'},[stop.type]) : null,
    stop.creative_mode ? h('span',{class:'chip outline'},[stop.creative_mode]) : null,
    state.settings.ibsMode ? h('span',{class:'chip'},[stop.ibs_level || '—']) : null
  ].filter(Boolean));

  const addr = h('a',{
    class:'addr',
    href: stop.google_maps_url || mapsUrlFromAddress(stop.address),
    target:'_blank',
    rel:'noopener'
  },[
    h('div',{},[
      h('div',{},[stop.address || '[Add address in Data tab]']),
      h('small',{},['Tap to open Maps'])
    ]),
    h('div',{class:'chip'},['↗'])
  ]);
  addr.addEventListener('contextmenu', (e)=>{ e.preventDefault(); copyText(stop.address); });

  const btnRow = h('div',{class:'btnRow'},[
    h('button',{class:'btn', onClick:()=>window.open(stop.google_maps_url || mapsUrlFromAddress(stop.address),'_blank')},['Maps']),
    h('button',{class:'btn', onClick:()=>window.open(stop.grab_url || grabUrlFromAddress(stop.address),'_blank')},['Grab']),
    h('button',{class:'btn'+(done?' primary':''), onClick:()=>toggleDone(stop.id)},[done?'Done ✓':'Done']),
    h('button',{class:'btn'+(skipped?' primary':''), onClick:()=>toggleSkip(stop.id)},[skipped?'Skip ✓':'Skip']),
    h('button',{class:'btn ghost', onClick:()=>copyText(stop.address)},['Copy address'])
  ]);

  const ibsDetails = h('details',{},[
    h('summary',{},['IBS Notes']),
    h('div',{class:'sheetText', style:'margin-top:8px;'},[stop.ibs_notes || '—'])
  ]);

  if(state.settings.ibsMode){
    // Auto-open IBS notes for SAFE and CAUTION
    if(stop.ibs_level === 'Safe' || stop.ibs_level === 'Caution') ibsDetails.open = true;
  }

  const promptBtn = h('button',{class:'btn', onClick:()=>{
    const prompts = Array.isArray(stop.creative_prompts) ? stop.creative_prompts : [];
    const lines = prompts.map((p,i)=>`<div style="margin:8px 0;">${i+1}. ${escapeHtml(p)}</div>`).join('');
    openSheet(`${stop.creative_mode || 'Creative'} Prompts`, lines || '<div class="sheetText">No prompts set.</div>');
  }},['Prompt']);

  const noteKey = stop.id;
  const noteVal = state.stopNotes[noteKey] || '';
  const noteBox = h('textarea',{class:'noteArea', placeholder:'Personal note (saved)…'},[]);
  noteBox.value = noteVal;
  noteBox.addEventListener('input', ()=>{ state.stopNotes[noteKey] = noteBox.value; persistAll(); });

  const noteDetails = h('details',{},[
    h('summary',{},['Personal note']),
    h('div',{style:'margin-top:10px;'},[noteBox])
  ]);

  // Assemble
  card.appendChild(h('div',{class:'row'},[leftMeta, withinDate ? reorder : null].filter(Boolean)));
  card.appendChild(title);
  card.appendChild(subline);
  card.appendChild(addr);
  card.appendChild(h('div',{class:'btnRow'},[promptBtn]));
  card.appendChild(btnRow);

  // IBS notes visible by default if IBS mode is on and safe/caution
  card.appendChild(ibsDetails);
  card.appendChild(noteDetails);

  return card;
}

function toggleDone(id){
  state.done[id] = !state.done[id];
  if(state.done[id]) state.skipped[id] = false;
  persistAll();
  render();
}
function toggleSkip(id){
  state.skipped[id] = !state.skipped[id];
  if(state.skipped[id]) state.done[id] = false;
  persistAll();
  render();
}

function moveStop(id, delta){
  // move within same date only
  const idx = itinerary.findIndex(s=>s.id===id);
  if(idx<0) return;
  const date = itinerary[idx].date;
  // collect indices for that date in current order
  const indices = itinerary.map((s,i)=>({s,i})).filter(x=>x.s.date===date).map(x=>x.i);
  const pos = indices.indexOf(idx);
  if(pos<0) return;
  const newPos = pos + delta;
  if(newPos<0 || newPos>=indices.length) return;
  const swapIdx = indices[newPos];
  const tmp = itinerary[idx];
  itinerary[idx] = itinerary[swapIdx];
  itinerary[swapIdx] = tmp;
  persistAll();
  render();
}

function renderTodayView(root){
  const d = selectedDate();
  const dayStops = itinerary.filter(s=>s.date===d);

  const title = h('div',{},[
    h('div',{class:'sectionTitle'},['Today']),
    h('div',{class:'small'},[`Showing: ${formatDayLabel(d)}`])
  ]);

  root.appendChild(title);

  const toolkit = renderToolkit();
  if(toolkit) root.appendChild(toolkit);

  if(!dayStops.length){
    root.appendChild(h('div',{class:'card'},[
      h('p',{class:'h1'},['No stops today']),
      h('div',{class:'sheetText'},['Add stops in the Data tab.'])
    ]));
    return;
  }

  let stops = [...dayStops].sort((a,b)=>stopSortKey(a).localeCompare(stopSortKey(b)));

  // filters
  stops = applyFilters(stops);

  // move done/skipped to bottom
  const active = stops.filter(s=>!state.done[s.id] && !state.skipped[s.id]);
  const completed = stops.filter(s=>state.done[s.id] || state.skipped[s.id]);
  const ordered = [...active, ...completed];

  for(const s of ordered){
    root.appendChild(renderStopCard(s, false));
  }
}

function renderByDayView(root){
  root.appendChild(h('div',{class:'sectionTitle'},['By Day']));

  const toolkit = renderToolkit();
  if(toolkit) root.appendChild(toolkit);

  const dates = getDates();

  // Mobile-first: show details by default so days never look "empty".
  // You can still collapse a day by tapping its header.
  for(const d of dates){
    const stops = itinerary.filter(s=>s.date===d);
    const dayLabel = stops[0]?.day_label || '';

    const day = h('div',{class:'day'},[]);
    const plusEl = h('div',{class:'chip'},['−']);
    const head = h('div',{class:'dayHead', onClick:()=>{
      day.classList.toggle('open');
      plusEl.textContent = day.classList.contains('open') ? '−' : '+';
    }},[
      h('div',{},[
        h('div',{class:'dayTitle'},[`${dayLabel} • ${formatDayLabel(d)}`]),
        h('div',{class:'dayMeta'},[TRIP_META.base])
      ]),
      plusEl
    ]);

    const body = h('div',{class:'dayBody'},[]);

    // Day notes + inspo links
    const dn = state.dayNotes[d] || '';
    const dnArea = h('textarea',{class:'noteArea', placeholder:'Day note (saved)…'},[]);
    dnArea.value = dn;
    dnArea.addEventListener('input', ()=>{ state.dayNotes[d] = dnArea.value; persistAll(); });

    const inspoWrap = renderInspoSection(d);

    body.appendChild(h('details',{},[
      h('summary',{},['Day note']),
      h('div',{style:'margin-top:10px;'},[dnArea])
    ]));
    body.appendChild(inspoWrap);

    // Stops
    let dayStops = stops.slice().sort((a,b)=>stopSortKey(a).localeCompare(stopSortKey(b)));
    dayStops = applyFilters(dayStops);

    const active = dayStops.filter(s=>!state.done[s.id] && !state.skipped[s.id]);
    const completed = dayStops.filter(s=>state.done[s.id] || state.skipped[s.id]);
    const ordered = [...active, ...completed];

    for(const s of ordered){
      body.appendChild(renderStopCard(s, true));
    }

    day.appendChild(head);
    day.appendChild(body);

    // Open by default (important for first-time users)
    day.classList.add('open');
    root.appendChild(day);
  }

  // Optional (Any day)
  const optional = itinerary.filter(s=>String(s.date).toUpperCase()==='ANY');
  if(optional.length){
    const day = h('div',{class:'day'},[]);
    const plusEl = h('div',{class:'chip'},['−']);
    const head = h('div',{class:'dayHead', onClick:()=>{
      day.classList.toggle('open');
      plusEl.textContent = day.classList.contains('open') ? '−' : '+';
    }},[
      h('div',{},[
        h('div',{class:'dayTitle'},['Optional • Any day']),
        h('div',{class:'dayMeta'},['Use when you have extra energy'])
      ]),
      plusEl
    ]);
    const body = h('div',{class:'dayBody'},[]);
    let opts = optional.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    opts = applyFilters(opts);
    for(const s of opts){
      body.appendChild(renderStopCard(s, false));
    }
    day.appendChild(head);
    day.appendChild(body);
    day.classList.add('open');
    root.appendChild(day);
  }
}

function applyFilters(stops){
  let out = [...stops];
  if(state.settings.hideSkipIfTired){
    out = out.filter(s=>!s.skip_if_tired);
  }
  if(state.settings.ibsMode && state.settings.filterSafeOnly){
    out = out.filter(s=>s.ibs_level==='Safe' || s.ibs_level==='Caution');
  }
  return out;
}

function renderMapListView(root){
  root.appendChild(h('div',{class:'sectionTitle'},['Map List']));
  const d = selectedDate();
  const stops = itinerary.filter(s=>s.date===d).sort((a,b)=>stopSortKey(a).localeCompare(stopSortKey(b)));

  root.appendChild(h('div',{class:'small'},[`Showing: ${formatDayLabel(d)} (change date in header)`]));

  for(const s of applyFilters(stops)){
    root.appendChild(h('div',{class:'card'},[
      h('div',{class:'row'},[
        h('div',{class:'meta'},[
          h('span',{class:'chip'},[s.time_block]),
          h('span',{class:'chip outline'},[s.type||'Stop'])
        ]),
        h('span',{class:'chip muted'},[s.district||''])
      ]),
      h('p',{class:'h1', style:'margin:0;'},[s.name]),
      h('div',{class:'btnRow'},[
        h('button',{class:'btn', onClick:()=>window.open(s.google_maps_url || mapsUrlFromAddress(s.address),'_blank')},['Open Maps']),
        h('button',{class:'btn', onClick:()=>window.open(s.grab_url || grabUrlFromAddress(s.address),'_blank')},['Grab']),
        h('button',{class:'btn ghost', onClick:()=>copyText(s.address)},['Copy address'])
      ]),
      h('div',{class:'sheetText'},[s.address || '—'])
    ]));
  }
}

function renderNotesView(root){
  root.appendChild(h('div',{class:'sectionTitle'},['Notes']));

  const packingKey = '__packing';
  const ibsKey = '__ibs';
  const generalKey = '__general';

  const defaults = {
    [generalKey]: 'Trip focus: slow, creative, IBS-friendly.\n\nOne theme: texture / light / signage.',
    [packingKey]: '- Watercolor kit (A5)\n- Water brush\n- Small towel\n- 1 book\n- Electrolytes\n- Buscopan (if prescribed)\n- Comfortable shoes',
    [ibsKey]: '- Avoid garlic/onion; sauce on the side\n- Prefer rice + lean protein\n- Early dinner\n- Hydrate + warm tea\n- Rest window before flight'
  };

  const noteBlocks = [
    {key: generalKey, title:'Trip-wide notes'},
    {key: packingKey, title:'Packing list'},
    {key: ibsKey, title:'IBS reminders'}
  ];

  for(const nb of noteBlocks){
    const val = state.dayNotes[nb.key] ?? defaults[nb.key] ?? '';
    const ta = h('textarea',{class:'noteArea'},[]);
    ta.value = val;
    ta.addEventListener('input', ()=>{ state.dayNotes[nb.key] = ta.value; persistAll(); });
    root.appendChild(h('div',{class:'card'},[
      h('div',{class:'row'},[
        h('div',{class:'dayTitle'},[nb.title]),
        h('span',{class:'chip muted'},['Saved'])
      ]),
      ta
    ]));
  }
}

function renderInspoSection(dateStr){
  const items = Array.isArray(state.dayInspo[dateStr]) ? state.dayInspo[dateStr] : [];

  const labelInput = h('input',{type:'text', placeholder:'Label (e.g., “Cafe interior”)'});
  const urlInput = h('input',{type:'url', placeholder:'Link (IG/Pinterest/Notes URL)'});

  const addBtn = h('button',{class:'btn primary', onClick:()=>{
    const label = (labelInput.value||'').trim();
    const url = (urlInput.value||'').trim();
    if(!url) return;
    const next = [...items, {label: label || 'Inspo', url}];
    state.dayInspo[dateStr] = next;
    persistAll();
    render();
  }},['Add link']);

  const list = h('div',{class:'linkList'},[]);
  for(let i=0;i<items.length;i++){
    const it = items[i];
    list.appendChild(h('div',{class:'linkItem'},[
      h('div',{},[
        h('div',{class:'small'},[it.label||'Inspo']),
        h('a',{href:it.url,target:'_blank',rel:'noopener'},[it.url])
      ]),
      h('button',{class:'btn', onClick:()=>{
        const next = items.slice();
        next.splice(i,1);
        state.dayInspo[dateStr] = next;
        persistAll();
        render();
      }},['Remove'])
    ]));
  }

  return h('details',{},[
    h('summary',{},['Inspo links (no uploads)']),
    h('div',{style:'margin-top:10px; display:flex; flex-direction:column; gap:10px;'},[
      h('div',{class:'twoCol'},[
        h('div',{},[h('label',{},['Label']), labelInput]),
        h('div',{},[h('label',{},['URL']), urlInput])
      ]),
      h('div',{style:'display:flex; gap:10px; align-items:center;'},[
        addBtn,
        h('span',{class:'small'},['Tip: long-press a stop address card to copy.'])
      ]),
      items.length ? list : h('div',{class:'small'},['No links yet.'])
    ])
  ]);
}

function renderDataView(root){
  root.appendChild(h('div',{class:'sectionTitle'},['Data']));

  // JSON editor
  const ta = h('textarea',{class:'noteArea', style:'min-height:220px;'},[]);
  ta.value = JSON.stringify(itinerary, null, 2);

  const err = h('div',{class:'small danger', style:'display:none;'},['']);

  const btnApply = h('button',{class:'btn primary', onClick:()=>{
    try{
      const parsed = JSON.parse(ta.value);
      if(!Array.isArray(parsed)) throw new Error('Itinerary JSON must be an array');
      // Minimal validation
      for(const s of parsed){
        if(!s.id || !s.date || !s.name) throw new Error('Each stop needs: id, date, name');
      }
      itinerary = parsed;
      hydrateLinks();
      persistAll();
      err.style.display='none';
      renderHeader();
      render();
      openSheet('Saved', '<div class="sheetText">Itinerary updated.</div>');
    }catch(e){
      err.textContent = 'JSON error: ' + e.message;
      err.style.display='block';
    }
  }},['Apply JSON']);

  const btnExport = h('button',{class:'btn', onClick:()=>downloadText('itinerary.json', JSON.stringify(itinerary, null, 2))},['Export JSON']);
  const btnImport = h('button',{class:'btn', onClick:()=>filePick((text)=>{ ta.value = text; })},['Import JSON']);
  const btnDefault = h('button',{class:'btn ghost', onClick:()=>{
    itinerary = structuredClone(ITINERARY_DEFAULT);
    hydrateLinks();
    persistAll();
    ta.value = JSON.stringify(itinerary, null, 2);
    renderHeader();
    render();
  }},['Restore defaults']);

  // Quick add stop
  const fName = h('input',{type:'text', placeholder:'Stop name'});
  const fDate = h('input',{type:'text', placeholder:'YYYY-MM-DD (e.g., 2026-01-28)'});
  fDate.value = selectedDate();
  const fBlock = h('input',{type:'text', placeholder:'Time block (e.g., Morning)'});
  const fAddr = h('input',{type:'text', placeholder:'Address'});
  const fMaps = h('input',{type:'url', placeholder:'Google Maps URL (optional)'});

  const btnAdd = h('button',{class:'btn primary', onClick:()=>{
    const name = (fName.value||'').trim();
    const date = (fDate.value||'').trim();
    const block = (fBlock.value||'').trim() || 'Afternoon';
    const addr = (fAddr.value||'').trim();
    if(!name || !date){
      openSheet('Missing fields', '<div class="sheetText">Please fill at least <b>name</b> and <b>date</b>.</div>');
      return;
    }
    const id = 'x-' + Math.random().toString(16).slice(2,10);
    const dayLabel = (itinerary.find(s=>s.date===date)?.day_label) || 'Day';
    const s = {
      id,
      day_label: dayLabel,
      date,
      time_block: block,
      start_time: '',
      end_time: '',
      name,
      type: 'Landmark',
      address: addr,
      district: '',
      google_maps_url: fMaps.value.trim(),
      grab_url: '',
      ibs_level: 'Safe',
      ibs_notes: '',
      creative_mode: 'Rest',
      creative_prompts: ['','',''],
      priority: 'Nice',
      duration_mins: 30,
      tags: [],
      skip_if_tired: true
    };
    if(!s.google_maps_url && s.address) s.google_maps_url = mapsUrlFromAddress(s.address);
    if(!s.grab_url && s.address) s.grab_url = grabUrlFromAddress(s.address);

    itinerary.push(s);
    persistAll();
    ta.value = JSON.stringify(itinerary, null, 2);
    renderHeader();
    render();
    // clear
    fName.value=''; fAddr.value=''; fMaps.value='';
    openSheet('Added', '<div class="sheetText">Stop added. You can reorder with ↑ ↓ in By Day.</div>');
  }},['Add stop']);

  // Backup center
  const btnBackup = h('button',{class:'btn', onClick:()=>downloadText('vn-trip-backup.json', JSON.stringify({
    itinerary,
    state,
    meta: TRIP_META,
    version: APP.version,
    exported_at: new Date().toISOString()
  }, null, 2))},['Download Backup']);

  const btnRestore = h('button',{class:'btn', onClick:()=>filePick((text)=>{
    try{
      const parsed = JSON.parse(text);
      if(!parsed || !Array.isArray(parsed.itinerary) || !parsed.state) throw new Error('Invalid backup file');
      itinerary = parsed.itinerary;
      state = parsed.state;
      hydrateLinks();
      persistAll();
      renderHeader();
      render();
      openSheet('Restored', '<div class="sheetText">Backup restored.</div>');
    }catch(e){
      openSheet('Restore failed', `<div class="sheetText danger">${escapeHtml(e.message)}</div>`);
    }
  })},['Restore Backup']);

  const btnReset = h('button',{class:'btn ghost', onClick:()=>{
    openSheet('Reset all?', `
      <div class="sheetText">This will wipe saved status/notes + restore defaults.</div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn" id="cancelReset">Cancel</button>
        <button class="btn primary" id="doReset">Reset</button>
      </div>
    `);
    setTimeout(()=>{
      const c = document.getElementById('cancelReset');
      const d = document.getElementById('doReset');
      if(c) c.onclick = () => closeSheet();
      if(d) d.onclick = () => {
        itinerary = structuredClone(ITINERARY_DEFAULT);
        state = {
          done: {}, skipped: {}, stopNotes: {}, dayNotes: {}, dayInspo: {},
          settings: { ibsMode:false, filterSafeOnly:false, hideSkipIfTired:false, selectedDate:null, activeTab:'byday' }
        };
        hydrateLinks();
        persistAll();
        closeSheet();
        renderHeader();
        render();
      };
    }, 0);
  }},['Reset All']);

  root.appendChild(h('div',{class:'card'},[
    h('div',{class:'row'},[h('div',{class:'dayTitle'},['Edit itinerary JSON']), h('span',{class:'chip muted'},['Saved locally'])]),
    err,
    ta,
    h('div',{class:'btnRow'},[btnApply, btnImport, btnExport, btnDefault])
  ]));

  root.appendChild(h('div',{class:'card'},[
    h('div',{class:'dayTitle'},['Add Stop (quick)']),
    h('div',{class:'twoCol'},[
      h('div',{},[h('label',{},['Name']), fName]),
      h('div',{},[h('label',{},['Date']), fDate])
    ]),
    h('div',{class:'twoCol'},[
      h('div',{},[h('label',{},['Time block']), fBlock]),
      h('div',{},[h('label',{},['Address']), fAddr])
    ]),
    h('div',{},[h('label',{},['Maps URL (optional)']), fMaps]),
    h('div',{class:'btnRow'},[btnAdd, h('span',{class:'small'},['Reorder later using ↑ ↓ on cards (By Day).'])])
  ]));

  root.appendChild(h('div',{class:'card'},[
    h('div',{class:'dayTitle'},['Backup Center']),
    h('div',{class:'sheetText'},['Download everything (itinerary + notes + done/skip + settings) as a single JSON, and restore anytime.']),
    h('div',{class:'btnRow'},[btnBackup, btnRestore, btnReset])
  ]));
}

function render(){
  renderHeader();
  const root = el('#viewRoot');
  root.innerHTML = '';

  const tab = state.settings.activeTab || 'byday';
  const tEls = els('.tab');
  tEls.forEach(x=>x.classList.toggle('active', x.dataset.tab===tab));

  if(tab==='today') renderTodayView(root);
  else if(tab==='byday') renderByDayView(root);
  else if(tab==='map') renderMapListView(root);
  else if(tab==='notes') renderNotesView(root);
  else if(tab==='data') renderDataView(root);
}

function escapeHtml(str){
  return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/******** File helpers ********/
function downloadText(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
}

function filePick(onText){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json,text/plain';
  input.onchange = async () => {
    const file = input.files && input.files[0];
    if(!file) return;
    const text = await file.text();
    onText(text);
  };
  input.click();
}

/******** Tabs ********/
els('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    state.settings.activeTab = tab.dataset.tab;
    persistAll();
    render();
  });
});

/******** Modal ********/
el('#sheetClose').onclick = closeSheet;
el('#overlay').addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeSheet(); });

/******** PWA install ********/
let installPrompt = null;
window.__deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  installPrompt = e;
  window.__deferredPrompt = e;
  renderHeader();
});

el('#btnInstall').addEventListener('click', async ()=>{
  if(!installPrompt) return;
  installPrompt.prompt();
  await installPrompt.userChoice;
  installPrompt = null;
  window.__deferredPrompt = null;
  renderHeader();
});

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

// Initial render
render();

</script>
</body>
</html>
